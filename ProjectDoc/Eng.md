# Project Documentation: Tuttiud Student Support Platform

**Version: 2.3.0**
**Last Updated: 2025-10-27**

## 1. Vision & Purpose

Tuttiud helps education teams coordinate instruction, track student progress, and keep each organization in control of its data. The first public release focuses on the core daily workflows shared by every customer:

- Administrators provision the tenant database once, back up the org, create students, and assign each student to an instructor.
- Instructors sign in with their organization, view only the students they are responsible for, and capture structured session records after every meeting.
- Both roles rely on a secure onboarding wizard that guarantees every tenant starts from the exact same schema and role configuration.

## 2. Architecture & Technology Stack

- **Desktop shell:** Electron packaged with electron-builder for Windows/macOS. Launches the React SPA inside a dedicated window or the default browser.
- **Frontend:** React + Vite + Tailwind + shadcn/ui. Routing uses a `HashRouter` to remain desktop friendly. All secure operations funnel through context providers (`SupabaseProvider`, `OrgProvider`).
- **Backend/API:** Azure Functions host the `/api/*` proxy endpoints. Every handler validates the caller’s Supabase JWT, checks organization membership, decrypts the dedicated tenant key, and then performs reads/writes with a server-side Supabase client (`tenantClient`).
- **Data Platform:** Each organization owns a Supabase Postgres project. The canonical schema lives in the `tuttiud` namespace and is created through the setup wizard’s SQL script. Row Level Security is enforced for every table.

## 3. Canonical Database Setup

The **only** supported bootstrap path is the SQL script stored in [`src/lib/setup-sql.js`](../src/lib/setup-sql.js). It is exposed verbatim to admins in the onboarding wizard and may be re-run safely at any time.

Key characteristics:

1. Creates the `tuttiud` schema and the tables `Instructors`, `Students`, `SessionRecords`, and `Settings`.
2. Enables RLS for every table and installs permissive policies (`Allow full access...`) for the authenticated role during MVP phase.
3. Creates the reusable `app_user` role and grants usage/select privileges.
4. Defines `tuttiud.setup_assistant_diagnostics()` which now confirms schema + table existence, verifies RLS + policies on every MVP table, and checks the critical indexes used by instructor/student dashboards.
5. Generates a five-year JWT named `APP_DEDICATED_KEY (COPY THIS BACK TO THE APP)` that the admin pastes back into the wizard. The key is later encrypted and stored in the Control DB via `/api/save-org-credentials`.

## 4. Data Model (MVP)

| Table | Purpose | Key Columns |
| :---- | :------ | :---------- |
| `tuttiud."Instructors"` | Directory of teaching staff. | `id` (uuid PK), `name`, contact fields, `is_active`, `metadata` |
| `tuttiud."Students"` | Student roster for the organization. | `id`, `name`, `contact_info`, `assigned_instructor_id` (FK → `Instructors.id`), `tags`, `notes`, `metadata` |
| `tuttiud."SessionRecords"` | Canonical record of every instruction session. | `id`, `date`, `student_id` (FK → `Students.id`), `instructor_id` (FK → `Instructors.id`), `service_context`, `content`, `deleted`, timestamps, `metadata` |
| `tuttiud."Settings"` | JSON configuration bucket per tenant. | `id`, `key` (unique), `settings_value` |

Supporting indexes:

- `SessionRecords_student_date_idx` for chronological student lookups.
- `SessionRecords_instructor_idx` for instructor dashboards.

## 5. Security Model & Keys

- RLS is enabled for every table. During the MVP all authenticated users have full access. Instructors can still be scoped in the application layer (filters by `assigned_instructor_id`). Future releases can tighten RLS without altering client code.
- The wizard captures the dedicated JWT generated by the SQL script. The frontend never stores it in plaintext; `/api/save-org-credentials` encrypts the value with `APP_ORG_CREDENTIALS_ENCRYPTION_KEY` before saving it to the Control DB (`organizations.dedicated_key_encrypted`).
- Serverless endpoints decrypt the key only while creating the privileged `tenantClient`. The browser keeps using the anon key for read-only diagnostics (`tuttiud.setup_assistant_diagnostics`) and must proxy all writes through `/api/*`.

## 6. Setup Wizard Flow (Settings → Supabase Setup)

Implemented in [`src/components/settings/SetupAssistant.jsx`](../src/components/settings/SetupAssistant.jsx):

1. **Database Preparation** – Presents the canonical SQL, explains how to run it in the Supabase SQL Editor, and reminds the admin to copy the JWT output.
2. **Provide the Application Key** – Offers a dedicated textarea + clipboard helper for the JWT (`APP_DEDICATED_KEY`). The key stays local until the admin explicitly saves it.
3. **Validation** – Runs `tuttiud.setup_assistant_diagnostics()` via the anon Supabase client. The function returns pass/fail rows for schema, RLS, policy, and index coverage. When all checks succeed the wizard posts the JWT to `/api/save-org-credentials`, which encrypts the key, persists `dedicated_key_saved_at`, `verified_at`, and `setup_completed`, and the UI records the verification timestamp before unlocking the rest of the app. Errors surface in-line with actionable guidance and keep the wizard on the same step for retry.

The wizard always tracks loading, error, and success states, ensuring accessibility (`aria-live`) and RTL support.

## 7. Core API Endpoints & MVP Feature Support

### 7.1 Serverless API Contracts

| Route | Method | Audience | Purpose |
| :---- | :----- | :------- | :------ |
| `/api/instructors` | GET | Admin/Owner | Reads `org_memberships` for `role = 'member'` and joins `profiles` to return `{ id, name }` pairs for instructor pickers. |
| `/api/students` | GET | Admin/Owner | Returns every `tuttiud."Students"` row ordered by name for roster management. |
| `/api/students` | POST | Admin/Owner | Inserts a student (name + optional contact info and instructor assignment) and echoes the created row. |
| `/api/students/{studentId}` | PUT | Admin/Owner | Updates mutable student fields (name, contact info, instructor) and returns the refreshed row or 404. |
| `/api/my-students` | GET | Member/Admin/Owner | Filters the roster by `assigned_instructor_id === caller.user_id`, supporting the instructor dashboard. |
| `/api/sessions` | POST | Member/Admin/Owner | Inserts a `SessionRecords` entry after confirming members only write for students assigned to them. |

All endpoints expect the tenant identifier (`org_id`) in the request body or query string. Authentication is enforced with the Supabase JWT provided by the desktop/web client, and every handler builds the tenant Supabase client through `api/_shared/org-bff.js` to reuse encryption, membership, and error handling routines.

### 7.2 User Story Mapping

| User Story | Implementation Notes |
| :--------- | :------------------- |
| **Instructor creates & manages session records** | `/api/sessions` writes into `SessionRecords` after verifying (for members) that the student belongs to them. Future endpoints can extend to edit/delete using the same helper. |
| **Instructor sees only assigned students** | `/api/my-students` scopes the roster by `assigned_instructor_id = user_id`, so instructors never receive other students even before frontend filtering. |
| **Administrator manages roster & assignments** | `/api/students` (POST/PUT) plus `/api/instructors` give admins the CRUD surface to create students and assign them to instructors. |
| **Administrator views full roster + instructor pairing** | `/api/students` (GET) returns the entire roster and includes assignments, allowing the admin UI to render organization-wide dashboards. |

## 8. Developer Notes

- Keep `SETUP_SQL_SCRIPT` as the single source of truth; import it anywhere the script must be displayed (wizard, docs, etc.).
- `verifyOrgConnection` (`src/runtime/verification.js`) now expects a Supabase data client and returns the diagnostics array so callers can render pass/fail status.
- All onboarding status updates should call `recordVerification(orgId, timestamp)` to persist `setup_completed` / `verified_at` on the control-plane organization row.
- Documentation must remain bilingual (see `ProjectDoc/Heb.md`) and the README should highlight the onboarding checklist for quick reference.

## 9. Admin Student Management UI

- **Feature slice** – all admin-only UI now lives in `src/features/admin/`. Components scoped to this feature sit under `components/` while page-level containers are housed in `pages/`.
- **StudentManagementPage.jsx** – renders the `/admin/students` route. It reads the active organization from `OrgContext`, fetches `/api/students` on mount, surfaces loading/error/empty states, and keeps an instructor map in memory for display. Dialog state is managed locally for add/edit flows.
- **AddStudentForm.jsx** – collects `name` and `contactInfo`, enforces client-side validation, and raises `onSubmit` with trimmed values. The form is rendered inside a dialog launched from the Student Management page.
- **AssignInstructorModal.jsx** – opens from each roster row, requests `/api/instructors` when displayed, and submits the chosen instructor through `PUT /api/students/{id}`. It blocks dismissals while saving and emits `onAssigned` so the page can refresh the roster.
- **Routing & navigation** – `src/main.jsx` redirects `/Employees` to `/admin/students` and mounts the new page. `src/Layout.jsx` updates the sidebar entry (label + URL) to match the student-focused workflow and refreshes the sidebar tagline to “student & instruction management”.
