# תיעוד פרויקט: פלטפורמת Tuttiud לתמיכת תלמידים

**גרסה: 2.1.0**
**עודכן לאחרונה: 2025-10-25**

## 1. חזון ומטרה

Tuttiud מאפשרת לצוותי הוראה לתאם שיעורים, לעקוב אחרי התקדמות תלמידים ולשמור על שליטה מלאה בנתוני הארגון. הגרסה הראשונית מתמקדת בזרימות העבודה היומיומיות הבסיסיות:

- מנהלי מערכת מאתחלים את מסד הנתונים הטננטי, מגבים את הארגון, יוצרים תלמידים ומקצים לכל תלמיד מדריך.
- מדריכים נכנסים לארגון שלהם, רואים רק את התלמידים שהוקצו להם ומתעדים מפגשי הדרכה מובנים.
- שני התפקידים מסתמכים על אשף הקמה מאובטח שמבטיח שכל טננט מתחיל מאותו סכמת בסיס והגדרות הרשאות.

## 2. ארכיטקטורה וסטאק טכנולוגי

- **מעטפת שולחנית:** Electron נארז בעזרת electron-builder ל-Windows/macOS. מפעיל את ה-SPA של React בחלון ייעודי או בדפדפן ברירת המחדל.
- **Frontend:** React + Vite + Tailwind + shadcn/ui. הניווט מבוסס `HashRouter` למתן תאימות שולחנית. כל הפעולות המאובטחות עוברות דרך ספקי הקשר (`SupabaseProvider`, `OrgProvider`).
- **Backend/API:** פונקציות Azure מארחות את פרוקסי `/api/*`. כל נקודת קצה מאמתת את ה-JWT של Supabase, בודקת חברות בארגון, מפענחת את המפתח הייעודי ומבצעת את הקריאות/כתיבות עם לקוח Supabase צד-שרת (`tenantClient`).
- **פלטפורמת נתונים:** לכל ארגון פרויקט Supabase Postgres ייעודי. הסכימה הקנונית חיה ב-`tuttiud` ונוצרת דרך סקריפט ההקמה של האשף. RLS מופעל על כל הטבלאות.

## 3. סקריפט ההקמה הקנוני

דרך האתחול היחידה הנתמכת היא הסקריפט שנשמר ב-[`src/lib/setup-sql.js`](../src/lib/setup-sql.js). הסקריפט מוצג כלשונו למנהלים באשף ההגדרה וניתן להרצה חוזרת בבטחה.

מאפיינים עיקריים:

1. יוצר את הסכימה `tuttiud` ואת הטבלאות `Instructors`, `Students`, `SessionRecords`, `Settings`.
2. מפעיל RLS לכל הטבלאות ומגדיר מדיניות גישה מקיפה (`Allow full access...`) לרול `authenticated` בתקופת ה-MVP.
3. יוצר את תפקיד `app_user` ומעניק הרשאות שימוש/קריאה.
4. מגדיר את הפונקציה `tuttiud.setup_assistant_diagnostics()` שבודקת כעת קיום סכימה וטבלאות, מאמתת ש-RLS ומדיניות קיימים בכל טבלת MVP, ומוודאת את האינדקסים הקריטיים ללוחות הבקרה של מדריכים ותלמידים.
5. מייצר JWT לחמש שנים בשם `APP_DEDICATED_KEY (COPY THIS BACK TO THE APP)` שהמנהל מדביק חזרה באשף. המפתח מוצפן ונשמר במסד הבקרה דרך `/api/save-org-credentials`.

## 4. מודל הנתונים (MVP)

| טבלה | תפקיד | עמודות מרכזיות |
| :--- | :---- | :------------- |
| `tuttiud."Instructors"` | ספר מדריכים ארגוני. | `id` (uuid PK), `name`, פרטי קשר, `is_active`, `metadata` |
| `tuttiud."Students"` | רשימת התלמידים של הארגון. | `id`, `name`, `contact_info`, `assigned_instructor_id` (FK → `Instructors.id`), `tags`, `notes`, `metadata` |
| `tuttiud."SessionRecords"` | רישום קנוני של מפגשי הוראה. | `id`, `date`, `student_id` (FK → `Students.id`), `instructor_id` (FK → `Instructors.id`), `service_context`, `content`, `deleted`, חותמות זמן, `metadata` |
| `tuttiud."Settings"` | מאגר הגדרות JSON לכל טננט. | `id`, `key` (ייחודי), `settings_value` |

אינדקסים תומכים:

- `SessionRecords_student_date_idx` לאיתור תלמידים כרונולוגי.
- `SessionRecords_instructor_idx` ללוחות בקרה של מדריכים.

## 5. מודל אבטחה ומפתחות

- RLS מופעל על כל הטבלאות. ב-MVP כל משתמש מאומת מקבל גישה מלאה, בעוד שהסינון בפועל נעשה בשכבת האפליקציה (לפי `assigned_instructor_id`). בעתיד ניתן להחמיר מדיניות ללא שינוי צד-לקוח.
- האשף קולט את ה-JWT שהסקריפט יוצר. המפתח אינו נשמר בגלוי בדפדפן; `/api/save-org-credentials` מצפין אותו עם `APP_ORG_CREDENTIALS_ENCRYPTION_KEY` לפני שהוא נשמר ב-Control DB (`organizations.dedicated_key_encrypted`).
- פונקציות ה-Azure מפענחות את המפתח רק בעת יצירת `tenantClient`. הצד-הקליינט משתמש במפתח האנונימי לבדיקות (`tuttiud.setup_assistant_diagnostics`) וחייב לבצע כל כתיבה דרך `/api/*`.

## 6. זרימת אשף ההקמה (הגדרות → חיבור Supabase)

ממומש ב-[`src/components/settings/SetupAssistant.jsx`](../src/components/settings/SetupAssistant.jsx):

1. **הכנת בסיס הנתונים** – מציג את הסקריפט הקנוני, מסביר כיצד להריץ אותו בעורך ה-SQL של Supabase ומזכיר להעתיק את ה-JWT בסיום.
2. **הדבקת המפתח הייעודי** – מציע שדה טקסט ייעודי וכפתור הדבקה כדי להזין את ה-JWT (`APP_DEDICATED_KEY`). המפתח נשאר מקומי עד לשמירה מפורשת.
3. **אימות ושמירה** – מריץ את `tuttiud.setup_assistant_diagnostics()` עם מפתח ה-anon. הפונקציה מחזירה שורות Pass/Fail עבור סכימה, RLS, מדיניות ואינדקסים. כשכל הבדיקות מצליחות האשף שולח את המפתח ל-`/api/save-org-credentials`, שמצפין אותו, מעדכן `dedicated_key_saved_at`, `verified_at` ו-`setup_completed`, וה-UI מתעד את זמן האימות לפני פתיחת שאר המערכת. תקלות מוצגות בצורה ברורה ומאפשרות ניסיון חוזר.

האשף מציג מצבי טעינה, שגיאה והצלחה, כולל הכרזות נגישות (`aria-live`) ותמיכה מלאה ב-RTL.

## 7. תמיכה בסיפורי המשתמש המרכזיים

| סיפור משתמש | הערות מימוש |
| :----------- | :----------- |
| **מדריך יוצר ומנהל רישומי מפגשים** | טבלת `SessionRecords` שומרת את נתוני המפגש. הממשק יפלטר לפי המדריך המחובר ויקרא ל-`/api/session-records` (ייבנה) המשתמש במפתח הייעודי לכתיבה. |
| **מדריך רואה רק את תלמידיו** | השדה `Students.assigned_instructor_id` מקשר בעלות. בלקוח, הסלקטורים מסננים לפי פרופיל המדריך והדשבורד פונה ל-`/api/students?scope=mine`. |
| **מנהל מערכת מנהל תלמידים ושיוכים** | ממשקי הניהול יספקו CRUD דרך נקודות קצה מאובטחות (`/api/students`, `/api/instructors`) שמוסיפות לטבלאות ה-MVP. גיבויים מתבצעים ב-Control DB לאחר ההקמה. |
| **מנהל מערכת רואה את כל התלמידים והשיוך למדריך** | דוחות מאחדים את `Students` ו-`Instructors`. האינדקסים שומרים על ביצועים גם בקבוצות גדולות. |

## 8. הערות למפתחים

- `SETUP_SQL_SCRIPT` הוא מקור האמת היחיד לסקריפט; ייבאו אותו לכל מקום שבו מציגים את הסקריפט.
- `verifyOrgConnection` (`src/runtime/verification.js`) מקבל כעת לקוח Supabase ומחזיר את מערך התוצאות כדי לרנדר סטטוס.
- בעת השלמת האשף חובה לקרוא ל-`recordVerification(orgId, timestamp)` כדי לעדכן את `setup_completed` / `verified_at` ב-Control DB.
- יש לשמור על תאימות מלאה בין מסמך זה לבין התרגום האנגלי ועל עדכון ה-README עם רשימת הצעדים.
