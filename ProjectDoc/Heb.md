# תיעוד פרויקט: פלטפורמת Tuttiud לתמיכת תלמידים

**גרסה: 1.6.2**
**עודכן לאחרונה: 2025-12-15**

> **מוסכמות מפתחים:** לפרטים על מבנה תיקיות, כללי שמות, דפוסי API וארגון לפי פיצ'רים – ראו [Conventions.md](./Conventions.md).

## 1. חזון ומטרה

Tuttiud מאפשרת לצוותי הוראה לתאם שיעורים, לעקוב אחרי התקדמות תלמידים ולשמור על שליטה מלאה בנתוני הארגון. הגרסה הראשונית מתמקדת בזרימות העבודה היומיומיות הבסיסיות:

- מנהלי מערכת מאתחלים את מסד הנתונים הטננטי, מגבים את הארגון, יוצרים תלמידים ומקצים לכל תלמיד מדריך.
- מדריכים נכנסים לארגון שלהם, רואים רק את התלמידים שהוקצו להם ומתעדים מפגשי הדרכה מובנים.
- שני התפקידים מסתמכים על אשף הקמה מאובטח שמבטיח שכל טננט מתחיל מאותו סכמת בסיס והגדרות הרשאות.

## 2. ארכיטקטורה וסטאק טכנולוגי

- **מעטפת שולחנית:** Electron נארז בעזרת electron-builder ל-Windows/macOS. מפעיל את ה-SPA של React בחלון ייעודי או בדפדפן ברירת המחדל.
- **Frontend:** React + Vite + Tailwind + shadcn/ui. הניווט מבוסס `HashRouter` למתן תאימות שולחנית. כל הפעולות המאובטחות עוברות דרך ספקי הקשר (`SupabaseProvider`, `OrgProvider`).
- **Backend/API:** פונקציות Azure מארחות את פרוקסי `/api/*`. כל נקודת קצה מאמתת את ה-JWT של Supabase, בודקת חברות בארגון, מפענחת את המפתח הייעודי ומבצעת את הקריאות/כתיבות עם לקוח Supabase צד-שרת (`tenantClient`).
- **פלטפורמת נתונים:** לכל ארגון פרויקט Supabase Postgres ייעודי. הסכימה הקנונית חיה ב-`tuttiud` ונוצרת דרך סקריפט ההקמה של האשף. RLS מופעל על כל הטבלאות.

## 3. סקריפט ההקמה הקנוני

דרך האתחול היחידה הנתמכת היא הסקריפט שנשמר ב-[`src/lib/setup-sql.js`](../src/lib/setup-sql.js). הסקריפט מוצג כלשונו למנהלים באשף ההגדרה וניתן להרצה חוזרת בבטחה.

מאפיינים עיקריים:

1. יוצר את הסכימה `tuttiud` ואת הטבלאות `Instructors`, `Students`, `SessionRecords`, `Settings`.
2. מפעיל RLS לכל הטבלאות ומגדיר מדיניות גישה מקיפה (`Allow full access...`) לרול `authenticated` בתקופת ה-MVP.
3. יוצר את תפקיד `app_user` ומעניק הרשאות שימוש/קריאה.
4. מגדיר את הפונקציה `tuttiud.setup_assistant_diagnostics()` שבודקת כעת קיום סכימה וטבלאות, מאמתת ש-RLS ומדיניות קיימים בכל טבלת MVP, ומוודאת את האינדקסים הקריטיים ללוחות הבקרה של מדריכים ותלמידים.
5. מוסיף פקודות `ALTER TABLE ... ADD COLUMN IF NOT EXISTS` כך שהרצה חוזרת של הסקריפט משלימה עמודות חדשות בטננטים קיימים בלי לאבד נתונים.
6. מייצר JWT לחמש שנים בשם `APP_DEDICATED_KEY (COPY THIS BACK TO THE APP)` שהמנהל מדביק חזרה באשף. המפתח מוצפן ונשמר במסד הבקרה דרך `/api/save-org-credentials`.

## 4. מודל הנתונים (MVP)

| טבלה | תפקיד | עמודות מרכזיות |
| :--- | :---- | :------------- |
| `tuttiud."Instructors"` | ספר מדריכים ארגוני. | `id` (uuid PK ששומר את `auth.users.id` ומנוהל ברמת האפליקציה), `name`, פרטי קשר, `is_active`, `metadata` (כולל `instructor_color` עבור צבע קבוע וייחודי) |
| `tuttiud."Students"` | רשימת התלמידים של הארגון. | `id`, `name`, `national_id` (אופציונלי, נאכף ייחודיות באפליקציה), `contact_info`, `contact_name`, `contact_phone`, `assigned_instructor_id` (FK → `Instructors.id`), `default_day_of_week` (1 = יום ראשון, 7 = שבת), `default_session_time`, `default_service`, `is_active` (boolean, ברירת מחדל `true`), `tags`, `notes`, `metadata`, `intake_responses` (היסטוריית קליטה חיצונית), `needs_intake_approval` (דגל לתור הקליטה) |
| `tuttiud."SessionRecords"` | רישום קנוני של מפגשי הוראה. | `id`, `date`, `student_id` (FK ניתן לריק → `Students.id` עבור דיווחים לא משויכים), `instructor_id` (FK → `Instructors.id`), `service_context`, `content` (JSON של תשובות לפי שאלה), `deleted`, `is_legacy` (מסמן שורות עבר שיובאו), חותמות זמן, `metadata` (כולל `unassigned_details` עד לפתרון) |
| `tuttiud."Settings"` | מאגר הגדרות JSON לכל טננט. | `id`, `key` (ייחודי), `settings_value` (כולל `intake_field_mapping`, `intake_important_fields`, `intake_display_labels`, `external_intake_secret` ו-`student_tags`) |

אינדקסים תומכים:

- `SessionRecords_student_date_idx` לאיתור תלמידים כרונולוגי.
- `SessionRecords_instructor_idx` ללוחות בקרה של מדריכים.

> **מיפוי זהויות מדריכים:** מאחר שמסד הנתונים הטננטי נפרד ממסד האימות המרכזי, העמודה `tuttiud."Instructors".id` אינה מוגנת במפתח זר למסד `auth`. האחריות לשמור על התאמה בין רשומת המדריך ל-`auth.users.id` מוטלת על שכבת האפליקציה בעת יצירה ועדכונים.

## 5. מודל אבטחה ומפתחות

- RLS מופעל על כל הטבלאות. ב-MVP כל משתמש מאומת מקבל גישה מלאה, בעוד שהסינון בפועל נעשה בשכבת האפליקציה (לפי `assigned_instructor_id`). בעתיד ניתן להחמיר מדיניות ללא שינוי צד-לקוח.
- האשף קולט את ה-JWT שהסקריפט יוצר. המפתח אינו נשמר בגלוי בדפדפן; `/api/save-org-credentials` מצפין אותו עם `APP_ORG_CREDENTIALS_ENCRYPTION_KEY` לפני שהוא נשמר ב-Control DB (`organizations.dedicated_key_encrypted`).
- פונקציות ה-Azure מפענחות את המפתח רק בעת יצירת `tenantClient`. הצד-הקליינט משתמש במפתח האנונימי לבדיקות (`tuttiud.setup_assistant_diagnostics`) וחייב לבצע כל כתיבה דרך `/api/*`.

## 6. זרימת אשף ההקמה (הגדרות → חיבור Supabase)

ממומש ב-[`src/components/settings/SetupAssistant.jsx`](../src/components/settings/SetupAssistant.jsx):

1. **הכנת בסיס הנתונים** – מציג את הסקריפט הקנוני, מסביר כיצד להריץ אותו בעורך ה-SQL של Supabase ומזכיר להעתיק את ה-JWT בסיום.
2. **הדבקת המפתח הייעודי** – מציע שדה טקסט ייעודי וכפתור הדבקה כדי להזין את ה-JWT (`APP_DEDICATED_KEY`). המפתח נשאר מקומי עד לשמירה מפורשת.
3. **אימות ושמירה** – מריץ את `tuttiud.setup_assistant_diagnostics()` עם מפתח ה-anon. הפונקציה מחזירה שורות Pass/Fail עבור סכימה, RLS, מדיניות ואינדקסים. כשכל הבדיקות מצליחות האשף שולח את המפתח ל-`/api/save-org-credentials`, שמצפין אותו, מעדכן `dedicated_key_saved_at`, `verified_at` ו-`setup_completed`, וה-UI מתעד את זמן האימות לפני פתיחת שאר המערכת. תקלות מוצגות בצורה ברורה ומאפשרות ניסיון חוזר.

האשף מציג מצבי טעינה, שגיאה והצלחה, כולל הכרזות נגישות (`aria-live`) ותמיכה מלאה ב-RTL.

## 7. נקודות קצה מרכזיות ותמיכת ה-MVP

### 7.1 חוזי API של פונקציות Azure

| נתיב | מתודה | קהל יעד | מטרה |
| :--- | :---- | :------- | :---- |
| `/api/instructors` | GET | מנהל/בעלים | קורא את `tuttiud."Instructors"` (ברירת מחדל: מדריכים פעילים) ומחזיר רשומות שמזוהות לפי מזהה המשתמש של Supabase (`id`). |
| `/api/students-list` | GET | כל המשתמשים | נקודת קצה מאוחדת; מנהלים רואים את כל התלמידים, משתמשים רגילים מסוננים לפי `assigned_instructor_id`. מחזיר תלמידים פעילים כברירת מחדל (`status=active`), עם אפשרויות `status=inactive` ו-`status=all` ופרמטר תאימות `include_inactive=true`. קליטות שהוסרו מסוננות תמיד. התגובה מחזירה גם את הדגל `is_active` להצגת סטטוס. מחליף את `/api/students` ו-`/api/my-students` הישנים. |
| `/api/students-list` | POST | מנהל/בעלים | מוסיף תלמיד (שם + פרטי קשר, הגדרות ברירת מחדל ושיוך למדריך) ומחזיר את הרשומה שנוצרה. |
| `/api/students-list/{studentId}` | PUT | מנהל/בעלים | מעדכן שדות תלמיד ניתנים לעריכה (שם, פרטי קשר, הגדרות ברירת מחדל, שיוך מדריך, `is_active`, תגיות, הערות) ומחזיר את הרשומה המעודכנת או 404. |
| `/api/students-check-id` | GET | כל המשתמשים | בודק ייחודיות של מספר זהות, עם אפשרות להתעלם מתלמיד קיים בעת עריכה. מחזיר `{ exists, student }` כדי לחסום כפילויות ולספק קישור לפרופיל. |
| `/api/students-search` | GET | מנהל/בעלים | חיפוש מטושטש לפי שם שמחזיר `{ id, name, national_id, is_active }` להצגת רמזי כפילות מתחת לשדה השם בטופס. |
| `/api/intake` | POST | רובוט חיצוני | נקודת קצה ציבורית לקליטת טפסי Microsoft Forms דרך Power Automate. דורשת את הכותרות `x-org-id` ו-`x-intake-secret` (מאומת מול `external_intake_secret`), מפענחת `html_content` לזוגות שאלה/תשובה, ממפה שדות לפי `intake_field_mapping` וכותבת `intake_responses` + `needs_intake_approval`. |
| `/api/intake/approve` | POST | מדריך | מאשר קליטה ממתינה ע\"י `needs_intake_approval=false` ורישום `metadata.last_approval` (זמן + מאשר + הסכמה). הקליטה חייבת להיות משויכת למדריך המאשר. |
| `/api/intake/dismiss` | POST | מנהל/בעלים | מסיר קליטה מתור הקליטה ע\"י ניקוי `needs_intake_approval` ורישום `metadata.last_intake_dismissal`. |
| `/api/intake/restore` | POST | מנהל/בעלים | משחזר קליטה שהוסרה ע\"י `needs_intake_approval=true` וסימון `metadata.intake_dismissal.active=false`. |
| `/api/intake/dismissed` | GET | מנהל/בעלים | מחזיר קליטות שהוסרו כדי להציגן באזור השחזור של תור הקליטה. |
| `/api/students-merge` | POST | מנהל/בעלים | ממזג קליטה לתלמיד קיים לפי בחירת שדות, מחבר את נתוני הקליטה לתלמיד היעד ומסמן את קליטת המקור כמוסרת. |
| `/api/students/maintenance-export` | GET | מנהל/בעלים | מחזיר CSV עם `system_uuid`, שם, מספר זהות, פרטי קשר, שיוך מדריך, הגדרות ברירת מחדל, תגיות וסטטוס פעילות לצורך ניקוי נתונים. |
| `/api/loose-sessions` | GET/POST | מנהל/בעלים | מציג רשימת דיווחים לא משויכים (`student_id IS NULL`) ומאפשר לפתור אותם ע"י שיוך לתלמיד קיים או יצירת תלמיד חדש; מסיר רק את `metadata.unassigned_details` ומשמר מטאדטה אחרת. |
| `/api/students/maintenance-import` | POST | מנהל/בעלים | מקבל טקסט CSV מעודכן לפי `system_uuid`, מעדכן רק שדות שהשתנו, בודק ייחודיות מספר זהות בכל שורה ומול המאגר, ומחזיר דו"ח כשלונות פר שורה. |
| `/api/my-students` | GET | מדריך/מנהל/בעלים | מסנן את הרשימה לפי `assigned_instructor_id === caller.id` (מזהה ה-Supabase של המשתמש) ומסתיר תלמידים לא פעילים אלא אם הארגון מאפשר זאת. תומך באותם פרמטרי `status` כמו נקודת הקצה למנהלים. |
| `/api/weekly-compliance` | GET | מדריך/מנהל/בעלים | מחזיר את נתוני "תצוגת הציות השבועית" עם מזהי הצבע של המדריכים, שבביי תלמידים לכל מועד, חלון שעות דינמי וסטטוס תיעוד (✔ הושלם / ✖ חסר) לכל מפגש בעבר. |
| `/api/sessions` | POST | מדריך/מנהל/בעלים | מוסיף רשומת `SessionRecords` (מטען תשובות במבנה JSON + הקשר שירות אופציונלי) לאחר אימות שמדריכים כותבים רק על תלמידים שהוקצו להם. |
| `/api/settings` | GET/POST/PUT/PATCH/DELETE | מנהל/בעלים (קריאה מותרת גם לחברים) | מספק CRUD מלא על הגדרות הטננט, כולל יצירת מפתחות חדשים כגון `session_form_config`. |
| `/api/user-context` | GET | משתמשים מחוברים | מחזיר את רשימת החברות וההזמנות הממתינות של המשתמש יחד עם פרטי הארגון (שם, מזהה, סטטוס חיבור) באמצעות לקוח ה-Admin של Supabase שעוקף את RLS. |

- **תזמון סטטוס הציות השבועי:** נקודת הקצה `/api/weekly-compliance` מסמנת מפגשים ללא תיעוד שתוזמנו לאותו היום כ-`missing` כבר מחצות (UTC). רק מפגשים עתידיים נשארים כ-`upcoming`, כך שהעמודה של היום מציגה מיד אם התיעוד הושלם גם לפני שעת המפגש.
- **תזמון סטטוס הציות היומי:** נקודת הקצה `/api/daily-compliance` מאמצת את אותו כלל. מפגשים ללא תיעוד עם `isoDate` הקטן או שווה לתאריך של היום (UTC) מסומנים כ-`missing`, כך שהטיימליין היומי נשאר מסונכרן עם מפת החום ומונע מפערים של אותו היום להופיע כ-`upcoming`.

- **רישום הרשאות:** טבלת השליטה כוללת כעת `can_reupload_legacy_reports` (ברירת מחדל `false`) כדי לשלוט ביכולת לבצע העלאות חוזרות של נתוני עבר.
- **ממשק ייבוא דוחות היסטוריים (פרטי תלמיד):** משתמשי Admin/Owner רואים כפתור "ייבוא דוחות היסטוריים" בדף התלמיד. הכפתור מנוטרל אם כבר בוצע ייבוא Legacy אלא אם הופעלה ההרשאה `can_reupload_legacy_reports`. המודל פותח באזהרת גיבוי, שואל האם מבנה ה-CSV תואם את טופס השאלון הנוכחי, ומציג ממשק מיפוי מתאים (תפריטי שאלות מול `session_form_config` או שמות מותאמים) עם בחירת עמודת תאריך חובה ואזהרת החלפה בעת העלאה חוזרת. בנוסף, המשתמש בוחר שיוך שירות: שירות אחיד לכל השורות (או ללא שירות) או עמודת שירות מתוך קובץ ה-CSV.
  - יציבות תפריטי נפתח במובייל (2025-11-20): כל רכיבי Select במודל הייבוא משתמשים ב-`modal={true}` כדי שנגיעה מחוץ לרשימה פתוחה תסגור רק את התפריט ולא את הדיאלוג כולו בטלפונים.
  - עדכון UI (2025-11-19): כפתור "המשך" באזהרת הגיבוי ממוקם ויזואלית בצד שמאל עם קישור הגיבוי מעליו, חיצי הניווט מכוונים אל היעד (חזרה → ימינה, המשך → שמאלה), כפתורי בחירת המבנה משתמשים באייקונים ברורים וטקסט מיושר לימין, בחירת הקובץ נעלמת לאחר בחירה (להחלפה חוזרים לשלב המבנה) עם טקסט עזר מיושר בהתאם ל-RTL, וסימון "אל תכללו" הפך לצ'קבוקס מפורש (עמודות תאריך מוסתרות כברירת מחדל עד ביטול הסימון).
  - ליטוש אשף (2025-11-21): שופרו הריווחים והיישור בכל השלבים, נוספה אפשרות "הסרת קובץ" בתוך הממשק להחלפה או ניקוי של קובץ ה-CSV בלי לסגור את החלון, והורחב שלב התצוגה המקדימה עם טבלת תאריכי מפגש שמראה כיצד המערכת מפרשת את העמודה שנבחרה.
  - תיקוני פריסה (2025-11-22): כל השלבים מוצגים ככרטיסי רקע לבן, עמודת תאריך המפגש הוצבה מעל אזור שיוך השירות כדי לחסוך מקום ולשמור היררכיה ברורה, כפתורי בחירה (כולל רענון/הסרה) קיבלו הדגשה צבעונית ומסגרת כדי להבהיר מה נבחר, טבלת התצוגה המקדימה מציגה עמודות תאריך צרות וברורות יותר, ופרסינג התאריכים עודכן לתמיכה גם בימים/חודשים בעלי ספרה אחת.
  - כרטיסי תצוגה במובייל (2025-11-24): שלב התצוגה המקדימה מציג שתי דוגמאות כשורות כרטיסים בערימה במסכים קטנים לקריאות טובה יותר, תוך שמירת הטבלה המלאה בטאבלטים ובדסקטופ.
- **צד שרת לייבוא Legacy (`POST /api/students/{id}/legacy-import`):** נקודה למנהלים/בעלי ארגון בלבד שבודקת את `can_reupload_legacy_reports` לפני שמאפשרת החלפה. כשמתאפשר ייבוא המערכת מוחקת רשומות `is_legacy` קיימות לתלמיד, קוראת את ה-CSV שנשלח (גוף JSON עם `csv_text`, `structure_choice`, `session_date_column` ו-`column_mappings` או `custom_labels`) ומכניסה רשומות `SessionRecords` חדשות עם `is_legacy=true`. ניתן להעביר `service_strategy=fixed` עם `service_context_value` ליישום שירות אחיד או `service_strategy=column` עם `service_context_column` כדי למפות שירות לפי שורה; ערכים ריקים נשמרים ללא שירות.
- **שיוך ומטא־דאטה בייבוא Legacy:** הרשומות המיובאות מקבלות מטא־דאטה כמו דיווח רגיל: `metadata` שומר `created_by`, `created_role`, `form_version`, ו-`source='legacy_import'`, וכל שורה כותבת `instructor_id` מהמדריך המשויך לתלמיד. ייבוא נכשל עם `student_missing_instructor` אם אין לתלמיד מדריך משויך.
- **לוגיקת הצגה של ייבוא Legacy:** בכל הצגת היסטוריית מפגשים נבדק `is_legacy`. רשומות רגילות מתרגמות את מפתחי התשובות לשמות השאלות מתוך `session_form_config` (כולל גרסאות), בעוד שרשומות Legacy מציגות את שמות העמודות כפי שהועלו. המימוש המשותף מכסה את היסטוריית התלמיד, תצוגת היום בלוח הבקרה וייצוא ה-PDF.
- **נרמול תאריכים לייבוא Legacy:** המערכת מקבלת תאריכים נפוצים (`YYYY-MM-DD`, `DD/MM/YYYY`, `DD.MM.YYYY`) וגם מספרי תאריך של Excel וממירה אותם ל-ISO לפני השמירה.

> **אמצעי הגנה על הסכימה:** ‎`/api/settings` מריץ כעת את `tuttiud.setup_assistant_diagnostics()` בכל פעם ש-Supabase מדווח על טבלאות חסרות או הרשאות חסרות. פערים בסכימה או במדיניות מוחזרים כ-HTTP ‎424 עם ‎`settings_schema_incomplete` / `settings_schema_unverified` וכוללים את שורות הדיאגנוסטיקה כדי שהאדמין יריץ מחדש את הסקריפט לפני ניסיון נוסף.

כל נקודות הקצה מצפות למזהה הטננט (`org_id`) בגוף הבקשה או בפרמטרי השאילתה. האימות מתבצע עם ה-JWT של Supabase שמספק הלקוח, וכל מטפל יוצר לקוח טננט דרך `api/_shared/org-bff.js` כדי למחזר את הלוגיקה של החברות, ההצפנה וטיפול השגיאות.

### 7.2 זרימת הזמנות (עדכון 2025-11)

1. **שליחת הזמנה בפונקציית Azure (`POST /api/invitations`)** – מנהלי המערכת מזניקים אימייל הזמנה שמטמיע בכתובת ההפניה את `token_hash` של Supabase ואת `invitation_token` של בקרת הארגון.
   - המטפל בודק כעת אם האימייל כבר משויך לחבר פעיל בטבלת `org_memberships` של אותו ארגון, ובמקרה כזה מחזיר תשובת HTTP ‎409 עם הודעת `user already a member` כדי שהממשק יציג שגיאה ממוקדת.
  - המטפל מאתר משתמשים קיימים באמצעות התאמת האימייל (באופן מנורמל) בטבלת `profiles`, ומשתמש ב-`id` של הפרופיל כדי לבדוק האם קיימת כבר רשומת `org_memberships` עבור אותו ארגון.
   - אם לקוח Supabase כבר קיים עבור כתובת האימייל, הפונקציה עדיין יוצרת את ההזמנה בטבלת השליטה אך מדלגת על `inviteUserByEmail`, ומחזירה `{ userExists: true }` כדי שהממשק יציג הודעת הצלחה מתאימה ויזהיר שניתן פשוט להתחבר.
   - רשומת ההזמנה נכתבת ל-`org_invitations` רק לאחר ש-Supabase מאשר שהאימייל נשלח. כאשר המשתמש כבר קיים (ולכן אין שליחה), הרשומה נוצרת מיד כדי שיוכל להשלים את ההזמנה ללא המתנה.
2. **אישור ידני (`CompleteRegistrationPage.jsx`)** – בעת פתיחת הקישור הלקוח טוען את `/complete-registration`, מושך את ההזמנה לפי הטוקן, מציג את כתובת האימייל בשדה לקריאה בלבד ואוסף באותו מסך סיסמה חדשה ואימות. שליחת הטופס מפעילה `verifyOtp` ומיד לאחר מכן `auth.updateUser` במהלך אחד, בודקת שמדובר בלפחות 6 תווים ומציגה התרעות בממשק עבור קישורים שפגו/שומשו או עבור שגיאות סיסמה.
3. **עמוד קבלה מודע-מצב (`AcceptInvitePage.jsx`)** – אימות מוצלח מפנה אל `/accept-invite?invitation_token=…`. העמוד מחייב סשן Supabase פעיל; משתמשים ללא סשן מנותבים ל-`/login` כשהטוקן נשמר.
4. **ממשק מונחה סטטוס** – העמוד קורא אל `/api/invitations/token/:token` שמחזיר כעת `{ status: 'pending' | 'accepted' | 'revoked' | 'declined' | 'expired' | 'failed', ... }`. ה-UI מציג:
   - `pending`: כפתורי אישור/דחייה עם טיפול בחוסר התאמה בין אימיילים.
   - `accepted`: הודעת הצלחה וכפתור מעבר ללוח הבקרה.
   - שאר הסטטוסים: הודעת מידע שאינה חוסמת המסבירה שהקישור אינו תקף.
5. **שמירה על התאמת האימייל** – אם כתובת האימייל של המשתמש המחובר שונה מכתובת ההזמנה, העמוד חוסם פעולות ומציע כפתור "התנתקות והחלפת חשבון".
6. **קונטקסט ארגוני (`GET /api/user-context`)** – לאחר התחברות ה-`OrgProvider` פונה לנקודת הקצה החדשה ומקבל גם את החברות הפעילות וגם את ההזמנות הממתינות כולל שם הארגון, כך שסקשן "הזמנות ממתינות" מציג את שם הארגון במקום "ארגון ללא שם" למרות מדיניות ה-RLS.

- **ניהול חברי צוות (`OrgMembersCard.jsx`)** – מנהלים ובעלי ארגון יכולים לערוך את שם החבר ישירות מכרטיס "חברי ארגון". שמירה מפעילה בקשת PATCH ל-`/api/org-memberships/{membershipId}` עם `fullName`, מעדכנת את העמודה `profiles.full_name` וגם את מטא-נתוני המשתמש ב-Supabase (`full_name`, `fullName`, `name`) כך שהשם החדש יוצג בקונסולת השליטה ובכניסות עתידיות.

### 7.3 מיפוי סיפורי המשתמש

| סיפור משתמש | הערות מימוש |
| :----------- | :----------- |
| **מדריך יוצר ומנהל רישומי מפגשים** | `/api/sessions` כותב ל-`SessionRecords` לאחר אימות (למדריכים) שהתלמיד אכן שייך להם. בעתיד ניתן להרחיב לעדכון/מחיקה עם אותו כלי עזר. |
| **מדריך רואה רק את תלמידיו** | `/api/students-list` מסנן באופן אוטומטי את הרשימה לפי `assigned_instructor_id = caller.id` עבור משתמשים שאינם מנהלים, כך שלא מתקבלות רשומות של תלמידים אחרים עוד לפני סינון בצד הלקוח. |
| **מנהל מערכת מנהל תלמידים ושיוכים** | `/api/students-list` (POST/PUT) יחד עם `/api/instructors` מספקים למנהלים את יכולות ה-CRUD הדרושות. |
| **מנהל מערכת רואה את כל התלמידים והשיוך למדריך** | `/api/students-list` (GET) מחזיר את כל הרשימה כולל השיוכים, כדי שהממשק הניהולי יציג תמונת מצב מלאה. |

## 8. הערות למפתחים

- `SETUP_SQL_SCRIPT` הוא מקור האמת היחיד לסקריפט; ייבאו אותו לכל מקום שבו מציגים את הסקריפט.
- הסקריפט מוסיף עתה את העמודה `Students.is_active boolean default true` ומשלים ערך `true` ברשומות קיימות. ההרצה חוזרת בטוחה הודות לשימוש עקבי ב-`ALTER TABLE ... ADD COLUMN IF NOT EXISTS`.
- גשר הקליטה (Intake Bridge) משתמש ב-`intake_field_mapping` וב-`external_intake_secret` מתוך `tuttiud.Settings`, ממפה לפי טקסט השאלה בעברית כפי שמופיע ב-HTML, שומר את ה-HTML המקורי ב-`intake_responses.intake_html_source`, והאישורים מתבצעים דרך `/api/intake/approve` כדי לשמור על בקרה ידנית עם הצהרת הסכמה. מנהלים משייכים מדריך ופרטים מתוך מודאל הדשבורד כדי שהמדריך המשויך יאשר את הקליטה, ויכולים להסיר קליטות שגויות דרך `/api/intake/dismiss` ולשחזר אותן דרך `/api/intake/restore`. בלוח הבקרה מוצג תקציר קליטה בסגנון Scorecard בחצי רוחב עמוד (חדשים/קיימים), ורשימת התור המלאה נפתחת במודאל עם כרטיסיות קליטה מתקפלות לצפייה מלאה.
- `SessionRecords.student_id` הוא כעת NULLABLE כדי לאפשר דיווחי סשן לא משויכים. בעת כתיבה יש להוסיף את `metadata.unassigned_details` באופן אדיטיבי (בלי למחוק מפתחות קיימים) ולוודא שכל השאילתות/נקודות הקצה יודעות להתמודד עם `student_id` שווה NULL.
- `verifyOrgConnection` (`src/runtime/verification.js`) מקבל כעת לקוח Supabase ומחזיר את מערך התוצאות כדי לרנדר סטטוס.
- בעת השלמת האשף חובה לקרוא ל-`recordVerification(orgId, timestamp)` כדי לעדכן את `setup_completed` / `verified_at` ב-Control DB.
- הקובץ `api/_shared/instructor-colors.js` מגדיר מאגר צבעים קבוע ומנגנון גרדיאנט לשיוך `metadata.instructor_color`. לפני שמחזירים רשימות מדריכים מנקודות קצה חדשות יש להריץ `ensureInstructorColors()`.
- נקודת הקצה `/api/weekly-compliance` מאגדת את לוחות הזמנים ברירת המחדל, בודקת רשומות `SessionRecords` ומחזירה את חלון השעות הדינמי והמקרא שוווידג'ט הציות צורך.
- יש לשמור על תאימות מלאה בין מסמך זה לבין התרגום האנגלי ועל עדכון ה-README עם רשימת הצעדים.
- זרימות OAuth קוראות ל-`supabase.auth.signInWithOAuth` עם `options.redirectTo`, שמחושב ככתובת הדפדפן המלאה (`origin + pathname + search + hash`) כאשר `window.location` זמין, או נופל למשתנים `VITE_PUBLIC_APP_URL` / `VITE_APP_BASE_URL` / `VITE_SITE_URL`, כך שהמשתמש חוזר בדיוק לעמוד שבו התחיל את כניסת Tuttiud לאחר ההזדהות מול ספק חיצוני.
- `bootstrapSupabaseCallback()` (`src/auth/bootstrapSupabaseCallback.js`) רץ לפני ש-`<HashRouter>` נטען, מעביר את פרמטרי Supabase לתבנית `#/login/?…` ושומר את המטען ב-`sessionStorage` כדי שהמשתמש יגיע ישירות למסך הכניסה ולא לדף הנחיתה.
- `src/pages/Login.jsx` קורא קודם את המטען שנשמר (או את פרמטרי ה-Hash), מציג הודעות שגיאה ידידותיות בעברית, משחרר את מצב הטעינה ומנקה את כתובת הדפדפן לפורמט הקנוני `#/login/?…` ללא פרמטרים של Supabase.
- `resolveRedirectUrl()` בתוך `src/auth/AuthContext.jsx` מסיר את פרמטרי Supabase, מאחד פרמטרים נוספים ומחזיר תמיד כתובת `#/login/` כאשר זוהו פרמטרי CallBack כדי שבקשות OAuth עתידיות יהיו נקיות משגיאות עבר.
- **צ'ק ליסט QA ידני – הפניית OAuth**: הדמיה של הפניה חזרה עם `code` בלבד צריכה להעלות את מסך הכניסה ללא הודעת שגיאה; הפניה עם `error=access_denied` צריכה להציג את ההתרעה המתורגמת ולנרמל את ה-URL ל-`#/login/?error=access_denied` לפני ניסיון נוסף.
- `AuthLayout` (`src/components/layouts/AuthLayout.jsx`) מאחד את מעטפת כל מסכי ההזדהות (כניסה, איפוס סיסמה, השלמת הרשמה) עם הרקע הממותג, לוגו לחיץ לעמוד הבית וכרטיס מרכזי. כל עמוד אחראי לספק רק את תוכן הטופס הפנימי.
- זרימת איפוס הסיסמה בנויה משני שלבים: `/Pages/ForgotPassword.jsx` מזניק את `resetPasswordForEmail` עם הפניה אל `/#/update-password`, ו-`/Pages/UpdatePassword.jsx` מוודא שסיסמאות תואמות לפני שהוא קורא לפעולת `updatePassword` החדשה מ-`AuthContext`. שני העמודים עושים שימוש בקומפוננטות מערכת העיצוב המעודכנת ומציגים מצבי טעינה, הצלחה ושגיאה ידידותיים ל-RTL.
- טופס הכניסה מציג כשלי אימות של Supabase בתוך התראה אדומה כדי שהמשתמשים יבינו מיד כשהפרטים שגויים.

## 9. ממשק ניהול תלמידים למנהלים

- **חלוקה לפיצ'רים** – כל ה-UI הייעודי למנהלים נמצא תחת `src/features/admin/`. רכיבים פנימיים חיים בתיקיית `components/` בעוד שקומפוננטות עמוד מלא נמצאות תחת `pages/`.
- **StudentManagementPage.jsx** – משרת את הנתיב `/admin/students`. הקומפוננטה קוראת את הארגון הפעיל מ-`OrgContext`, טוענת את `/api/students-list` עם `status=active` כברירת מחדל, מציגה מצבי טעינה/שגיאה/ריק, ושומרת מפת מדריכים בזיכרון לצורך הצגה. מצב הדיאלוגים מנוהל מקומית עבור הוספה ועריכה, והמסנן (פעילים/לא פעילים/הכול) נשמר ב-sessionStorage ומדגיש תלמידים לא פעילים בתגים ייעודיים.
- **DataMaintenanceModal.jsx** – זמין מפעולות הרשימה להורדת CSV תחזוקה (`/api/students-maintenance-export`) הכולל את כל השדות הניתנים לעריכה (UUID, תעודת זהות, טלפון, מדריך, תגיות, הגדרות ברירת מחדל, הערות, סטטוס פעילות) ולהעלאת CSV מעודכן (`/api/students-maintenance-import`). הייבוא מעדכן רק שדות שהשתנו, בודק ייחודיות מספר זהות בכל שורה ומול המאגר, מחזיר פירוט כשלונות לפי שורה ומרענן את הרשימה/מדריכים.
- **AddStudentForm.jsx** – אוספת פרטי קשר, ברירות מחדל ללוח זמנים, בחירת תגית ושדה הערות חופשי; מבצעת ולידציה על הקלט ומעבירה את הערכים המקוצצים (כולל ההערות) ל-`onSubmit` כדי שיישמרו דרך `/api/students-list`. הטופס מוצג בתוך דיאלוג שנפתח מדף הניהול.
- **AssignInstructorModal.jsx** – נפתח מכל שורה ברשימה, מבצע בקשה ל-`/api/instructors` בעת ההצגה ושולח את השיוך דרך `PUT /api/students-list/{id}`. מונע סגירה בזמן שמירה ומשדר `onAssigned` כדי לרענן את הרשימה.
- **EditStudentForm.jsx** – מוסיף מתג פעילות עם טקסט אזהרה כדי שמנהלים יוכלו להשבית ולהחזיר תלמידים לפעילות בלי לפגוע בנתונים היסטוריים, ומאפשר לעדכן את אותם פרטי קשר, לוח זמנים, תגיות והערות כאשר ההערות המקוצצות מועברות אל ה-API.
- **קישורי עומק ברשימה** – לחיצה על שם תלמיד מעבירה אל `/students/:id`, כך שמנהלים יכולים לצלול מיד לעמוד הפרטים החדש מבלי לעזוב את זרימת הניהול.
- **מעטפת וניווט** – `src/main.jsx` מפנה את `/Employees` ל-`/admin/students` ועוטף את הנתיבים המוגנים ב-`src/components/layout/AppShell.jsx`. המעטפת מציגה סרגל טאבים תחתון עם כפתור פעולה מרכזי במובייל ומומרת לסיידבר שמאלי במסכים רחבים תוך שמירה על דף הניהול במרכז.

## 10. לוח "התלמידים שלי" למדריכים

- **נתיב פיצ'ר** – חוויית המדריך חיה כעת תחת `src/features/instructor/`. רכיבים ייעודיים נשמרים ב-`components/`, בעוד
  שהמכולה `MyStudentsPage.jsx` ב-`pages/` מרכיבה את מצב העמוד המלא.
- **פריסת עמוד וניתוב** – `MyStudentsPage.jsx` מרכיבה את `PageLayout` המשותף, מזניקה בקשת `GET /api/my-students` לאחר שהחיבור
  לארגון מוכן, ומציגה מצבי טעינה, שגיאה וריק. כאשר הנתונים מתקבלים, כל תלמיד מוצג בתוך `Card` עם שם ופרטי קשר, כולל תגים שמדגישים תלמידים לא פעילים כאשר ההגדרה מאפשרת זאת.
- **סינון לפי מחזור חיים** – ברירת המחדל מסתירה תלמידים לא פעילים עבור מדריכים. כאשר ההגדרה הארגונית מאפשרת צפייה, העמוד מציג בורר פעילים/לא פעילים/הכול זהה למנהל ושומר את ברירת המחדל על "פעילים".
- **גישה לפרטי תלמיד** – כל כרטיס כולל קישור "צפייה בפרטי התלמיד" ל-`/students/:id`, המאפשר למדריכים לעבור לעמוד הפרטים המלא בלחיצה אחת.
- **עדכוני ניווט** – `AppShell.jsx` מחשבת את יעד התלמידים בהתאם לתפקיד: מנהלים ובעלים נשארים עם `/admin/students`,
  בעוד שמדריכים מופנים אל `/my-students`. `src/main.jsx` מספק את הנתיב `/my-students` כדי שמדריכים יפתחו מיד את הרשימה המסוננת.

## 11. דף בית ממוקד

- **ComplianceHeatmap** – `src/features/dashboard/components/ComplianceHeatmap.jsx` הפך לרכיב דו-מצבי משולב. הוא ממשיך לצייר את טבלת השעות-ימים על בסיס `/api/weekly-compliance`, שומר את מגירת הפרטים (`SessionListDrawer`) לכל תא, ומציג מצבי טעינה/שגיאה גלויים. במסכים רחבים ברירת המחדל היא תצוגה שבועית מלאה; מתחת ל-1015px מוצגת ברירת מחדל יומית עם בורר תאריכים. לחיצה על "תצוגה מפורטת" מחליפה את תוכן הווידג'ט לרשימת המפגשים של אותו היום, מזניקה קריאה אל `/api/daily-compliance`, ומציגה את הטיימליין ישירות בתוך לוח הבקרה במקום לפתוח מודל. שני ה-API-ים ממשיכים לאכוף פילטור תפקידים בצד השרת, כך שמדריכים רואים רק את התלמידים המשויכים אליהם.
- **SessionCardList** – `src/features/dashboard/components/SessionCardList.jsx` הוא הרכיב המציג את ציר הזמן האנכי עם כרטיסי התלמידים הצבועים לפי המדריך. הוא מקבץ מפגשים לפי שעת התחלה, מציג את סטטוס התיעוד (✔/✖/•) ומחזיק כפתורי "פתח" ו"תעד עכשיו". גם התצוגה המפורטת וגם `SessionListDrawer` משתמשים בו, כך שהאינטראקציות והסגנון נשארים אחידים בכל מסלולי הדריל-דאון.
- **פעולות בלוח הבקרה** – `DashboardPage.jsx` עדיין מקדם את כרטיסי הניווט ל"התלמידים שלי" / "ניהול תלמידים" ולפתיחת רישום מפגש חדש. ווידג'ט הציות מופיע כעת מתחת לכרטיסים הללו לאחר שהחיבור למסד הנתונים זמין, ובינתיים מופיעה הודעת הסבר במקום הלוח.
- **הדבק ניווט** – קישור "ראשי" במעטפת ממשיך להפנות אל `/`, ו-`/Dashboard` מפנה מחדש כדי לשמור על חוויית הבית כנתיב ברירת המחדל לאחר ההתחברות. ההפניות מאימות (כניסה, בחירת ארגון, השלמת הזמנה) עדיין מתכנסות אל `/`, ופריט "דוחות" המנוטרל שומר על כותרת הדרך-למפה.

## 12. יסודות מערכת העיצוב (Mobile-First UI Kit)

- **קונפיגורציית Tailwind** – `tailwind.config.js` מגדיר כעת סט טיפוגרפיה המבוסס על Nunito, פלטת צבעים סגולה רגועה (`primary`), גווני ניטרל נגישים (`neutral`) וצבעי סטטוס ייעודיים להצלחה, אזהרה ושגיאה. סולם המרווחים כולל טוקנים חדשים (`2xs` → `3xl`) שמקלים על מגע ויוצרים מרווח נשימה במסכים קטנים.
- **רכיבי בסיס** – הרכיבים הגנריים החדשים נמצאים תחת [`src/components/ui/Button.jsx`](../src/components/ui/Button.jsx), [`Card.jsx`](../src/components/ui/Card.jsx), [`Input.jsx`](../src/components/ui/Input.jsx) ו-[`PageLayout.jsx`](../src/components/ui/PageLayout.jsx). השתמשו בהם בבניית זרימות חדשות כדי לשמור על טיפוגרפיה, ריווח וניגודיות עקביים בין מובייל לשולחן עבודה.
- **אימוץ מדורג** – דפי המערכת הקיימים טרם שונו. משימות עתידיות יעבירו פיצ'רים לממשק החדש באמצעות קומפוזיציה של רכיבים אלו.

## 13. עמוד פרטי תלמיד וזרימת רישום מפגש

- **StudentDetailPage.jsx** – נתיב חדש `/students/:id` הזמין למנהלים ולמדריכים. טוען את התלמיד המתאים עם `status=all` כך שגם תלמידים לא פעילים נשארים נגישים, מציג פרטי קשר והגדרות תזמון, ומדגיש תלמידים לא פעילים בעזרת באנר לפני שמציג היסטוריית מפגשים עם טיפול במצב בו נקודת הקצה עדיין לא זמינה.
- **הצגת היסטוריית מפגשים** – העמוד מושך את `session_form_config` באמצעות `/api/settings?keys=session_form_config`, מנרמל את השאלות בעזרת `parseSessionFormConfig` וממפה את ערכי ה-JSON לתוויות בעברית. תגובת 404 מנקודת הקצה החדשה `/api/session-records` מתורגמת להודעת "לא תועדו מפגשים" כדי לאפשר בדיקות UI כבר היום.
- **SessionModalContext.jsx** – מסופק מתוך `AppShell.jsx` ומאפשר לכל עמוד לקרוא ל-`openSessionModal({ studentId, onCreated })`. כפתור ה-+ במובייל והקריאה בסיידבר בדסקטופ משתמשים בו, וכך גם עמוד פרטי התלמיד שמבקש לרענן לאחר שמירה.
- **NewSessionModal.jsx** – מנהלת את תלותי הנתונים: טוענת את רשימת התלמידים לפי תפקיד המשתמש וההרשאה לצפות בלא פעילים, מושכת את `session_form_config`, מציגה מצבי טעינה/שגיאה ושולחת בקשה אל `/api/sessions` עם השדות `{ student_id, date, service_context, content }`, תוך הפעלת `onCreated` אם הועבר.
- **NewSessionForm.jsx** – טופס בעברית לשאלון המפגש. בוחר תלמיד אוטומטית כאשר נפתח מעמוד הפרטים, מציג ליד כל תלמיד את יום/שעת ברירת המחדל, ממלא מראש את השירות, מסנכרן את בורר הפעילים/לא פעילים כך שהרשימות יתמקדו בתלמידים זמינים, ומאפשר להשיב לכל סוג שאלה שהוגדר (טקסט, טקסט ארוך, בחירה מרשימה, כפתורי בחירה, שדות מספריים וסולם מדורג). שדה התאריך נפתח כעת ריק ודורש בחירה יזומה של היום המתועד. ערכים ריקים נמחקים מהמטען לפני השליחה.
- **כלי עזר משותפים** – `src/features/students/utils/schedule.js` מרכז את עיבוד יום/שעה, `src/features/students/utils/endpoints.js` מאחד את בניית נתיבי הרשימות ו-`src/features/sessions/utils/form-config.js` מנרמל את תצורת השאלות כך שהמודל והעמוד ישתמשו באותה לוגיקה.
- **קטלוג תגיות תלמידים** – התגיות הארגוניות נשמרות בשורת `student_tags` בטבלת `tuttiud."Settings"`. נקודת הקצה `GET /api/settings/student-tags` זמינה לכל חבר בארגון הפעיל ומחזירה מערך תגיות מנורמל, בעוד `POST /api/settings/student-tags` (מנהלים/בעלי ארגון בלבד) מוסיפה תגית חדשה עם מזהה UUID ייחודי. בצד הלקוח משתמשים ב-`useStudentTags()` (`src/features/students/hooks/useStudentTags.js`) ובמרכיב `StudentTagsField.jsx` להצגת הבחירה והמודל במסכי יצירת/עריכת תלמידים. עמודת `Students.tags` שומרת מערך מזהי UUID (`uuid[]`). לשדרוג טננטים קיימים יש להריץ:
  ```sql
  ALTER TABLE tuttiud."Students"
    ALTER COLUMN tags TYPE uuid[]
    USING CASE
      WHEN tags IS NULL THEN NULL
      ELSE ARRAY(
        SELECT value::uuid
        FROM unnest(tags) AS value
      )
    END;
  ```
  עמוד פרטי התלמיד ממפה את מזהי התגיות לקטלוג ומציג את שמות התגיות כתגיות עיצוב (Badges). כאשר תגית חסרה בקטלוג, מוצג מזהה ה-UUID עם סגנון Outline כדי להתריע על נתון שדורש התאמה.

## 14. ניהול טופס המפגשים במסך ההגדרות

- **מסך הגדרות מעודכן** – `/Pages/Settings.jsx` מתמקד כעת בדיאגנוסטיקה, חיבור Supabase, הזמנות והכרטיס החדש לניהול שאלות המפגש. רכיבי מדיניות חופשה, חגים וסוגי העסקה הוסרו כדי למקד את המסך בתכולת Tuttiud הנוכחית.
- **בקרה לפי תפקיד** – רק מנהלי מערכת ובעלי ארגון רואים את ממשק הניהול. מדריכים/חברים ממשיכים לראות את כרטיס הניפוי אך אינם מקבלים הרשאות נוספות.
- **SessionFormManager.jsx** – נמצא ב-`src/components/settings/SessionFormManager.jsx`. הכלי טוען את `session_form_config`, מציג את כל השאלות, ומאפשר להוסיף, לערוך, לשנות סדר או להסיר שאלות לפני שמירה. כל שאלה מנהלת `id`, `label`, `type`, `placeholder`, `required`, `options` ונתוני טווח (לטווחי דירוג). כפתור "שמור שינויים" שומר דרך `upsertSetting`, והוולידציה מונעת מזהים כפולים או טווחים שגויים.
- **שדרוג כלי הפירוק** – `parseSessionFormConfig` שומר כעת גם `required`, `options` ונתוני טווח כדי שצרכנים בזמן ריצה יוכלו לרנדר פקדים עשירים יותר ועדיין להישאר תאימים להגדרות ישנות.
- **שימור אפשרויות** – הנורמליזציה בצד השרת (`api/settings/index.js`) שומרת כעת אובייקטי אפשרויות עם `value`, `label` ו-`id` אופציונלי כך שהגדרות שנשמרו אינן מתדרדרות ל-`[object Object]` והטופס נטען מחדש בדיוק כפי שהוזן.
- **התאמה בזרימת הרישום** – `NewSessionForm.jsx` תומך במגוון סוגי השאלות, מציג רשימות בחירה, כפתורי רדיו/כפתורים, שדות מספר וסולם מדורג לצד הטקסטים החופשיים, ודואג לאכוף שדות חובה בצד הלקוח. כפתור "שמירת מפגש" מושבת עד שכל השדות החיוניים (כולל התאריך החדש) עוברים את בדיקות התקינות המובנות של הדפדפן.

## 15. כלי ניהול

### סקריפט בדיקת גיבוי

קיים סקריפט Node.js עבור מנהלי מערכת לבדוק תקינות קובץ גיבוי ויכולת פענוח:

- **מיקום:** `test/verify-backup.cjs`
- **שימוש:**
  ```
  node test/verify-backup.cjs <נתיב-לקובץ-גיבוי> <סיסמה>
  ```
- **יכולות:**
  - טוען ומפענח קובץ גיבוי עם הסיסמה שסופקה
  - מציג תקציר מניפסט אם הצליח
  - מציג שגיאה אם הקובץ לא תקין או הסיסמה שגויה

הכלי חיוני לאימות גיבויים לפני שחזור או לצרכי בקרה.

## 16. הגדרת ארגון: חשיפת תלמידים לא פעילים למדריכים

- **מפתח ההגדרה** – `instructors_can_view_inactive_students` נשמר בטבלת `tuttiud."Settings"` ומוגדר כברירת מחדל ל-`false`, כך שמדריכים אינם רואים תלמידים לא פעילים עד שמנהל מאפשר זאת במפורש.
- **UI בהגדרות** – הקומפוננטה `StudentVisibilitySettings.jsx` מוסיפה כרטיס ייעודי (אייקון עין-סגורה) בתוך `Settings.jsx`. מנהלים ובעלי ארגון יכולים לקרוא את התיאור, לעדכן את ההגדרה דרך `upsertSetting` ולראות חיווי מצב; מדריכים ללא הרשאה אינם יכולים לשנות את הערך.
- **שילוב API** – נקודת הקצה `/api/students-list` בודקת את ההגדרה בצד השרת ומחזירה תלמידים לא פעילים רק אם הדגל דולק או שהמשתמש הוא מנהל. פרמטרי השאילתה (`status=active|inactive|all`) חלים על כל תפקידי המשתמשים עם מודל מסננים אחיד.
- **צרכנים בצד הלקוח** – `MyStudentsPage.jsx`, `NewSessionModal.jsx` ו-`NewSessionForm.jsx` טוענים את הערך באמצעות `fetchSettingsValue` ומתאימים את המסננים וה-UI בהתאם. בחירת המסנן של מנהלים נשמרת בטאב דרך `sessionStorage`.

## 17. ליטוש UI של אשף ייבוא דוחות היסטוריים (2025-12)

- **יישור משופר** – שלב המיפוי מציב את כרטיס עמודת התאריך במלוא הרוחב מעל כרטיס שיוך השירותים, כך ששניהם מנצלים את השטח בלי כותרות דחוסות.
- **קריאות כפתורים** – בחירות מבנה/שירות צבועות בסגול עם קו מתאר כמו בטופס מפגש חדש, וכפתורי שירות כמו "הסרת קובץ"/"רענון" קיבלו עיצוב outlined ברור שמרגיש כפתור.
- **תצוגה מקדימה בהקשר** – אזור התצוגה המקדימה שומר על כותרת יחידה (ללא שכפול של כותרת השלב), וסיכום האישור משתמש בחצים מותאמים ל-RTL (←) כדי להציג את כיוון המיפוי.
- **מרווח בטיחות במובייל** – תכולת הדיאלוג מוגבלת בגובה במסכים קטנים ומוסיפה ריפוד Safe Area כך שהאשף יישאר מעל סרגל התחתית/כפתור ה-+ גם לאחר בחירת קובץ.
