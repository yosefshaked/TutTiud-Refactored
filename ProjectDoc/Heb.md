# תיעוד פרויקט: פלטפורמת Tuttiud לתמיכת תלמידים

**גרסה: 2.8.3**
**עודכן לאחרונה: 2025-10-30**

## 1. חזון ומטרה

Tuttiud מאפשרת לצוותי הוראה לתאם שיעורים, לעקוב אחרי התקדמות תלמידים ולשמור על שליטה מלאה בנתוני הארגון. הגרסה הראשונית מתמקדת בזרימות העבודה היומיומיות הבסיסיות:

- מנהלי מערכת מאתחלים את מסד הנתונים הטננטי, מגבים את הארגון, יוצרים תלמידים ומקצים לכל תלמיד מדריך.
- מדריכים נכנסים לארגון שלהם, רואים רק את התלמידים שהוקצו להם ומתעדים מפגשי הדרכה מובנים.
- שני התפקידים מסתמכים על אשף הקמה מאובטח שמבטיח שכל טננט מתחיל מאותו סכמת בסיס והגדרות הרשאות.

## 2. ארכיטקטורה וסטאק טכנולוגי

- **מעטפת שולחנית:** Electron נארז בעזרת electron-builder ל-Windows/macOS. מפעיל את ה-SPA של React בחלון ייעודי או בדפדפן ברירת המחדל.
- **Frontend:** React + Vite + Tailwind + shadcn/ui. הניווט מבוסס `HashRouter` למתן תאימות שולחנית. כל הפעולות המאובטחות עוברות דרך ספקי הקשר (`SupabaseProvider`, `OrgProvider`).
- **Backend/API:** פונקציות Azure מארחות את פרוקסי `/api/*`. כל נקודת קצה מאמתת את ה-JWT של Supabase, בודקת חברות בארגון, מפענחת את המפתח הייעודי ומבצעת את הקריאות/כתיבות עם לקוח Supabase צד-שרת (`tenantClient`).
- **פלטפורמת נתונים:** לכל ארגון פרויקט Supabase Postgres ייעודי. הסכימה הקנונית חיה ב-`tuttiud` ונוצרת דרך סקריפט ההקמה של האשף. RLS מופעל על כל הטבלאות.

## 3. סקריפט ההקמה הקנוני

דרך האתחול היחידה הנתמכת היא הסקריפט שנשמר ב-[`src/lib/setup-sql.js`](../src/lib/setup-sql.js). הסקריפט מוצג כלשונו למנהלים באשף ההגדרה וניתן להרצה חוזרת בבטחה.

מאפיינים עיקריים:

1. יוצר את הסכימה `tuttiud` ואת הטבלאות `Instructors`, `Students`, `SessionRecords`, `Settings`.
2. מפעיל RLS לכל הטבלאות ומגדיר מדיניות גישה מקיפה (`Allow full access...`) לרול `authenticated` בתקופת ה-MVP.
3. יוצר את תפקיד `app_user` ומעניק הרשאות שימוש/קריאה.
4. מגדיר את הפונקציה `tuttiud.setup_assistant_diagnostics()` שבודקת כעת קיום סכימה וטבלאות, מאמתת ש-RLS ומדיניות קיימים בכל טבלת MVP, ומוודאת את האינדקסים הקריטיים ללוחות הבקרה של מדריכים ותלמידים.
5. מוסיף פקודות `ALTER TABLE ... ADD COLUMN IF NOT EXISTS` כך שהרצה חוזרת של הסקריפט משלימה עמודות חדשות בטננטים קיימים בלי לאבד נתונים.
6. מייצר JWT לחמש שנים בשם `APP_DEDICATED_KEY (COPY THIS BACK TO THE APP)` שהמנהל מדביק חזרה באשף. המפתח מוצפן ונשמר במסד הבקרה דרך `/api/save-org-credentials`.

## 4. מודל הנתונים (MVP)

| טבלה | תפקיד | עמודות מרכזיות |
| :--- | :---- | :------------- |
| `tuttiud."Instructors"` | ספר מדריכים ארגוני. | `id` (uuid PK ששומר את `auth.users.id` ומנוהל ברמת האפליקציה), `name`, פרטי קשר, `is_active`, `metadata` |
| `tuttiud."Students"` | רשימת התלמידים של הארגון. | `id`, `name`, `contact_info`, `contact_name`, `contact_phone`, `assigned_instructor_id` (FK → `Instructors.id`), `default_day_of_week` (1 = יום ראשון, 7 = שבת), `default_session_time`, `default_service`, `tags`, `notes`, `metadata` |
| `tuttiud."SessionRecords"` | רישום קנוני של מפגשי הוראה. | `id`, `date`, `student_id` (FK → `Students.id`), `instructor_id` (FK → `Instructors.id`), `service_context`, `content` (JSON של תשובות לפי שאלה), `deleted`, חותמות זמן, `metadata` |
| `tuttiud."Settings"` | מאגר הגדרות JSON לכל טננט. | `id`, `key` (ייחודי), `settings_value` |

אינדקסים תומכים:

- `SessionRecords_student_date_idx` לאיתור תלמידים כרונולוגי.
- `SessionRecords_instructor_idx` ללוחות בקרה של מדריכים.

> **מיפוי זהויות מדריכים:** מאחר שמסד הנתונים הטננטי נפרד ממסד האימות המרכזי, העמודה `tuttiud."Instructors".id` אינה מוגנת במפתח זר למסד `auth`. האחריות לשמור על התאמה בין רשומת המדריך ל-`auth.users.id` מוטלת על שכבת האפליקציה בעת יצירה ועדכונים.

## 5. מודל אבטחה ומפתחות

- RLS מופעל על כל הטבלאות. ב-MVP כל משתמש מאומת מקבל גישה מלאה, בעוד שהסינון בפועל נעשה בשכבת האפליקציה (לפי `assigned_instructor_id`). בעתיד ניתן להחמיר מדיניות ללא שינוי צד-לקוח.
- האשף קולט את ה-JWT שהסקריפט יוצר. המפתח אינו נשמר בגלוי בדפדפן; `/api/save-org-credentials` מצפין אותו עם `APP_ORG_CREDENTIALS_ENCRYPTION_KEY` לפני שהוא נשמר ב-Control DB (`organizations.dedicated_key_encrypted`).
- פונקציות ה-Azure מפענחות את המפתח רק בעת יצירת `tenantClient`. הצד-הקליינט משתמש במפתח האנונימי לבדיקות (`tuttiud.setup_assistant_diagnostics`) וחייב לבצע כל כתיבה דרך `/api/*`.

## 6. זרימת אשף ההקמה (הגדרות → חיבור Supabase)

ממומש ב-[`src/components/settings/SetupAssistant.jsx`](../src/components/settings/SetupAssistant.jsx):

1. **הכנת בסיס הנתונים** – מציג את הסקריפט הקנוני, מסביר כיצד להריץ אותו בעורך ה-SQL של Supabase ומזכיר להעתיק את ה-JWT בסיום.
2. **הדבקת המפתח הייעודי** – מציע שדה טקסט ייעודי וכפתור הדבקה כדי להזין את ה-JWT (`APP_DEDICATED_KEY`). המפתח נשאר מקומי עד לשמירה מפורשת.
3. **אימות ושמירה** – מריץ את `tuttiud.setup_assistant_diagnostics()` עם מפתח ה-anon. הפונקציה מחזירה שורות Pass/Fail עבור סכימה, RLS, מדיניות ואינדקסים. כשכל הבדיקות מצליחות האשף שולח את המפתח ל-`/api/save-org-credentials`, שמצפין אותו, מעדכן `dedicated_key_saved_at`, `verified_at` ו-`setup_completed`, וה-UI מתעד את זמן האימות לפני פתיחת שאר המערכת. תקלות מוצגות בצורה ברורה ומאפשרות ניסיון חוזר.

האשף מציג מצבי טעינה, שגיאה והצלחה, כולל הכרזות נגישות (`aria-live`) ותמיכה מלאה ב-RTL.

## 7. נקודות קצה מרכזיות ותמיכת ה-MVP

### 7.1 חוזי API של פונקציות Azure

| נתיב | מתודה | קהל יעד | מטרה |
| :--- | :---- | :------- | :---- |
| `/api/instructors` | GET | מנהל/בעלים | קורא את `tuttiud."Instructors"` (ברירת מחדל: מדריכים פעילים) ומחזיר רשומות שמזוהות לפי מזהה המשתמש של Supabase (`id`). |
| `/api/students` | GET | מנהל/בעלים | מחזיר את כל הרשומות ב-`tuttiud."Students"` לפי סדר אלפביתי, כולל פרטי קשר מורחבים והגדרות ברירת מחדל למפגשים. |
| `/api/students` | POST | מנהל/בעלים | מוסיף תלמיד (שם + פרטי קשר, הגדרות ברירת מחדל ושיוך למדריך) ומחזיר את הרשומה שנוצרה. |
| `/api/students/{studentId}` | PUT | מנהל/בעלים | מעדכן שדות תלמיד ניתנים לעריכה (שם, פרטי קשר, הגדרות ברירת מחדל, שיוך מדריך) ומחזיר את הרשומה המעודכנת או 404. |
| `/api/my-students` | GET | מדריך/מנהל/בעלים | מסנן את הרשימה לפי `assigned_instructor_id === caller.id` (מזהה ה-Supabase של המשתמש), לטובת דשבורד המדריך. |
| `/api/sessions` | POST | מדריך/מנהל/בעלים | מוסיף רשומת `SessionRecords` (מטען תשובות במבנה JSON + הקשר שירות אופציונלי) לאחר אימות שמדריכים כותבים רק על תלמידים שהוקצו להם. |
| `/api/settings` | GET/POST/PUT/PATCH/DELETE | מנהל/בעלים (קריאה מותרת גם לחברים) | מספק CRUD מלא על הגדרות הטננט, כולל יצירת מפתחות חדשים כגון `session_form_config`. |

כל נקודות הקצה מצפות למזהה הטננט (`org_id`) בגוף הבקשה או בפרמטרי השאילתה. האימות מתבצע עם ה-JWT של Supabase שמספק הלקוח, וכל מטפל יוצר לקוח טננט דרך `api/_shared/org-bff.js` כדי למחזר את הלוגיקה של החברות, ההצפנה וטיפול השגיאות.

### 7.2 מיפוי סיפורי המשתמש

| סיפור משתמש | הערות מימוש |
| :----------- | :----------- |
| **מדריך יוצר ומנהל רישומי מפגשים** | `/api/sessions` כותב ל-`SessionRecords` לאחר אימות (למדריכים) שהתלמיד אכן שייך להם. בעתיד ניתן להרחיב לעדכון/מחיקה עם אותו כלי עזר. |
| **מדריך רואה רק את תלמידיו** | `/api/my-students` מסנן את הרשימה לפי `assigned_instructor_id = caller.id`, כך שלא מתקבלות רשומות של תלמידים אחרים עוד לפני סינון בצד הלקוח. |
| **מנהל מערכת מנהל תלמידים ושיוכים** | `/api/students` (POST/PUT) יחד עם `/api/instructors` מספקים למנהלים את יכולות ה-CRUD הדרושות. |
| **מנהל מערכת רואה את כל התלמידים והשיוך למדריך** | `/api/students` (GET) מחזיר את כל הרשימה כולל השיוכים, כדי שהממשק הניהולי יציג תמונת מצב מלאה. |

## 8. הערות למפתחים

- `SETUP_SQL_SCRIPT` הוא מקור האמת היחיד לסקריפט; ייבאו אותו לכל מקום שבו מציגים את הסקריפט.
- `verifyOrgConnection` (`src/runtime/verification.js`) מקבל כעת לקוח Supabase ומחזיר את מערך התוצאות כדי לרנדר סטטוס.
- בעת השלמת האשף חובה לקרוא ל-`recordVerification(orgId, timestamp)` כדי לעדכן את `setup_completed` / `verified_at` ב-Control DB.
- יש לשמור על תאימות מלאה בין מסמך זה לבין התרגום האנגלי ועל עדכון ה-README עם רשימת הצעדים.
- זרימות OAuth קוראות ל-`supabase.auth.signInWithOAuth` עם `options.redirectTo`, שמחושב ככתובת הדפדפן המלאה (`origin + pathname + search + hash`) כאשר `window.location` זמין, או נופל למשתנים `VITE_PUBLIC_APP_URL` / `VITE_APP_BASE_URL` / `VITE_SITE_URL`, כך שהמשתמש חוזר בדיוק לעמוד שבו התחיל את כניסת Tuttiud לאחר ההזדהות מול ספק חיצוני.
- זרימת איפוס הסיסמה בנויה משני שלבים: `/Pages/ForgotPassword.jsx` מזניק את `resetPasswordForEmail` עם הפניה אל `/#/update-password`, ו-`/Pages/UpdatePassword.jsx` מוודא שסיסמאות תואמות לפני שהוא קורא לפעולת `updatePassword` החדשה מ-`AuthContext`. שני העמודים עושים שימוש בקומפוננטות מערכת העיצוב המעודכנת ומציגים מצבי טעינה, הצלחה ושגיאה ידידותיים ל-RTL.
- טופס הכניסה מציג כשלי אימות של Supabase בתוך התראה אדומה כדי שהמשתמשים יבינו מיד כשהפרטים שגויים.

## 9. ממשק ניהול תלמידים למנהלים

- **חלוקה לפיצ'רים** – כל ה-UI הייעודי למנהלים נמצא תחת `src/features/admin/`. רכיבים פנימיים חיים בתיקיית `components/` בעוד שקומפוננטות עמוד מלא נמצאות תחת `pages/`.
- **StudentManagementPage.jsx** – משרת את הנתיב `/admin/students`. הקומפוננטה קוראת את הארגון הפעיל מ-`OrgContext`, טוענת את `/api/students` עם העלייה, מציגה מצבי טעינה/שגיאה/ריק, ושומרת מפת מדריכים בזיכרון לצורך הצגה. מצב הדיאלוגים מנוהל מקומית עבור הוספה ועריכה.
- **AddStudentForm.jsx** – אוספת `name` ו-`contactInfo`, מבצעת ולידציה בסיסית ומזמנת `onSubmit` עם ערכים נקיים. הטופס מוצג בתוך דיאלוג שנפתח מדף הניהול.
- **AssignInstructorModal.jsx** – נפתח מכל שורה ברשימה, מבצע בקשה ל-`/api/instructors` בעת ההצגה ושולח את השיוך דרך `PUT /api/students/{id}`. מונע סגירה בזמן שמירה ומשדר `onAssigned` כדי לרענן את הרשימה.
- **מעטפת וניווט** – `src/main.jsx` מפנה את `/Employees` ל-`/admin/students` ועוטף את הנתיבים המוגנים ב-`src/components/layout/AppShell.jsx`. המעטפת מציגה סרגל טאבים תחתון עם כפתור פעולה מרכזי במובייל ומומרת לסיידבר שמאלי במסכים רחבים תוך שמירה על דף הניהול במרכז.

## 10. לוח "התלמידים שלי" למדריכים

- **נתיב פיצ'ר** – חוויית המדריך חיה כעת תחת `src/features/instructor/`. רכיבים ייעודיים נשמרים ב-`components/`, בעוד
  שהמכולה `MyStudentsPage.jsx` ב-`pages/` מרכיבה את מצב העמוד המלא.
- **פריסת עמוד וניתוב** – `MyStudentsPage.jsx` מרכיבה את `PageLayout` המשותף, מזניקה בקשת `GET /api/my-students` לאחר שהחיבור
  לארגון מוכן, ומציגה מצבי טעינה, שגיאה וריק. כאשר הנתונים מתקבלים, כל תלמיד מוצג בתוך `Card` עם שם ופרטי קשר.
- **עדכוני ניווט** – `AppShell.jsx` מחשבת את יעד התלמידים בהתאם לתפקיד: מנהלים ובעלים נשארים עם `/admin/students`,
  בעוד שמדריכים מופנים אל `/my-students`. `src/main.jsx` מספק את הנתיב `/my-students` כדי שמדריכים יפתחו מיד את הרשימה המסוננת.

## 11. דף בית ממוקד

- **DashboardPage.jsx** – נמצא ב-`src/pages/DashboardPage.jsx`, מציג קבלת פנים מותאמת למשתמש המחובר ושתי פעולות מודגשות:
  מעבר ל-`/my-students` והפעלה של זרימת `/TimeEntry` הזהה לכפתור ה-+ המרכזי.
- **ניתוב בית** – קישור "ראשי" במעטפת מפנה כעת אל `/`, ו-`/Dashboard` מפנה מחדש לעמוד זה כך שהוא הופך לנתיב ברירת המחדל
  לאחר הכניסה. כל ההפניות לאחר אימות (כניסה, בחירת ארגון, השלמת הזמנה) כעת מכוונות ל-`/` כיעד קנוני.
- **מצב קישור "דוחות"** – פריט הניווט "דוחות" מנוטרל במובייל ובדסקטופ, עם כותרת ריחוף "יכולות הדיווח יגיעו בקרוב!" שמונעת
  ניווט לעמוד שאינו פעיל ומבהירה את מפת הדרכים.

## 12. יסודות מערכת העיצוב (Mobile-First UI Kit)

- **קונפיגורציית Tailwind** – `tailwind.config.js` מגדיר כעת סט טיפוגרפיה המבוסס על Nunito, פלטת צבעים סגולה רגועה (`primary`), גווני ניטרל נגישים (`neutral`) וצבעי סטטוס ייעודיים להצלחה, אזהרה ושגיאה. סולם המרווחים כולל טוקנים חדשים (`2xs` → `3xl`) שמקלים על מגע ויוצרים מרווח נשימה במסכים קטנים.
- **רכיבי בסיס** – הרכיבים הגנריים החדשים נמצאים תחת [`src/components/ui/Button.jsx`](../src/components/ui/Button.jsx), [`Card.jsx`](../src/components/ui/Card.jsx), [`Input.jsx`](../src/components/ui/Input.jsx) ו-[`PageLayout.jsx`](../src/components/ui/PageLayout.jsx). השתמשו בהם בבניית זרימות חדשות כדי לשמור על טיפוגרפיה, ריווח וניגודיות עקביים בין מובייל לשולחן עבודה.
- **אימוץ מדורג** – דפי המערכת הקיימים טרם שונו. משימות עתידיות יעבירו פיצ'רים לממשק החדש באמצעות קומפוזיציה של רכיבים אלו.
